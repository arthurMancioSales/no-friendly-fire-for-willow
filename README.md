# ğŸ”¥ No Friendly Fire From Willow - DST

> A comprehensive quality-of-life mod for Don't Starve Together that protects teammates, structures, and items from unintended fire penalties when playing alongside Willow.

---

## ğŸ“‹ Overview

**No Friendly Fire From Willow** ensures that fire generated by Willow is safe for her allies and the environment, without nerfing her combat effectiveness. **Enemies can still be ignited and burned normally** â€” only teammate penalties and environmental spread are prevented.

This mod provides comprehensive fire protection with all features enabled by default, fully configurable through the mod options menu.

---

## ğŸ“‹ VisÃ£o Geral (PortuguÃªs)

**No Friendly Fire From Willow** garante que o fogo gerado pela Willow seja seguro para seus aliados e o ambiente, sem enfraquecer sua efetividade em combate. **Inimigos ainda podem ser incendiados e queimados normalmente** â€” apenas as penalidades aos companheiros de equipe e o espalhamento ambiental sÃ£o prevenidos.

Este mod oferece proteÃ§Ã£o abrangente contra fogo com todas as funcionalidades ativadas por padrÃ£o, totalmente configurÃ¡veis atravÃ©s do menu de opÃ§Ãµes do mod.

---

## âœ¨ Features

### ğŸ›¡ï¸ **Comprehensive Fire Protection System**

The mod implements a unified protection system that safeguards:

#### **Protected Entities:**
- âœ… All players (allies and yourself)
- âœ… Structures and walls
- âœ… Items on the ground (dropped loot)
- âœ… Passive creatures (rabbits, birds, butterflies, beefalo, catcoons, etc.)
- âœ… Any entity tagged as `"willow_fire_protected"`

#### **Not Protected (Can Burn Normally):**
- âŒ Monsters and hostile creatures
- âŒ Epic bosses
- âŒ Enemies explicitly tagged as hostile

---

### ğŸ”¥ **Willow Fire Source Detection**

The mod automatically identifies and tags fire sources created by Willow:
- Willow's Bernie (fire form)
- Combustion skill fires
- Lunar flames
- Shadow flames
- Torch fires from Willow
- Any fire effect with Willow as owner/creator

Tagged fires are marked with `"willow_fire_source"` to ensure proper tracking.

---

### ğŸŒ¡ï¸ **1. No Overheating From Willow Fires**

Players no longer suffer temperature increases from Willow's fire sources:
- Temperature component is wrapped to ignore heating from `"willow_fire_source"` tagged entities
- Normal campfires and other fire sources still work as intended
- Only affects heat from Willow's abilities

---

### ğŸ—¡ï¸ **2. No Damage When Attacking Burning Targets**

If an enemy is ignited by Willow, allies can safely interact:
- Attack without taking contact burn damage
- The `"onhitother"` event prevents contact burns
- Health is restored if damage is dealt by Willow fire
- Automatic extinguish on players attacked by Willow fire

---

### ğŸ“¦ **3. Dropped Loot Protection**

Items dropped by enemies killed with Willow's fire are automatically protected:
- **Fireproof tag** applied to all loot from `"burned_by_willow"` entities
- Cannot start smoldering
- Cannot be ignited
- Propagator component disabled (no fire spread)
- Works through `lootdropper` component interception

---

### ğŸŒ² **4. No Environmental Fire Spread**

Willow's fire sources have their propagation disabled:
- `spreadrange` set to 0
- `heatoutput` set to 0
- Fire won't spread to trees, grass, structures, or other burnable objects
- Behaves like controlled torch fire

---

### ğŸ”„ **5. Automatic Fire Extinguishing**

Protected entities are automatically extinguished when ignited:
- Listens to `"onignite"` events on all burnable entities
- Immediately extinguishes players, structures, passive creatures, and items
- Stops fire propagation on protected entities
- Monsters and hostiles can still burn normally

---

### ğŸ·ï¸ **6. Willow Damage Tracking System**

Enemies burned by Willow are properly marked:
- `"burned_by_willow"` tag applied through combat interception
- Tag automatically expires after 10 seconds
- Used by loot protection system to identify Willow-killed enemies
- Works through `combat.GetAttacked` wrapper

---

## âš™ï¸ Configuration Options

All features are **enabled by default** and can be toggled independently in the mod configuration:

| Setting                     | Description                                                                 | Default |
| --------------------------- | --------------------------------------------------------------------------- | ------- |
| `NO_WILLOW_OVERHEAT`        | Prevent overheating from Willow-generated heat sources                      | âœ… ON    |
| `NO_WILLOW_AOE_PENALTIES`   | Disable negative auras from Willow's flame effects                          | âœ… ON    |
| `NO_BURN_DAMAGE_ON_HITTING` | Prevent ally damage when attacking Willow-ignited enemies                   | âœ… ON    |
| `NO_SMOLDERING_FROM_WILLOW` | Loot from Willow-fire kills will not smolder or burn                        | âœ… ON    |
| `NO_WILLOW_FIRE_SPREAD`     | Willow's heat cannot spread to environment objects                          | âœ… ON    |
| `ENABLE_WILLOW_TAGGING`     | Properly tag all Willow fire sources for mod compatibility                  | âœ… ON    |
| `SHOW_VISUAL_INDICATOR`     | Shows a small icon near your character when protection is active (optional) | âŒ OFF   |

---

## ğŸ“ File Structure

```
no-friendly-fire-willow/
â”‚
â”œâ”€â”€ modinfo.lua          # Mod metadata and configuration options
â”œâ”€â”€ modmain.lua          # Unified main script with all protection systems
â”œâ”€â”€ modicon.tex          # Mod icon (texture)
â”œâ”€â”€ modicon.xml          # Mod icon (metadata)
â”‚
â””â”€â”€ README.md            # This file
```

**Architecture:** All protection systems are unified in a single `modmain.lua` file for optimal performance and compatibility.

---

## ğŸ”§ Technical Implementation

### **Component Wrapping:**
- `burnable.Ignite` - Tracks Willow fire sources
- `lootdropper.DropLoot` - Protects dropped items
- `combat.GetAttacked` - Marks burned enemies
- `temperature.DoDelta` - Prevents overheating

### **Event Listeners:**
- `"onignite"` - Auto-extinguish protected entities
- `"attacked"` - Heal fire damage from Willow sources
- `"onhitother"` - Prevent contact burns
- `"death"` - Apply fireproof to loot

### **Safety Features:**
- All operations wrapped in `SafePcall` to prevent crashes
- Server-side only execution (checks `IsServer()`)
- Deferred initialization with `DoTaskInTime(0, ...)` to avoid race conditions
- Defensive nil checks throughout

---

## ğŸ§© Compatibility

| Status | Description                                                                      |
| ------ | -------------------------------------------------------------------------------- |
| âœ…      | Compatible with most gameplay mods                                               |
| âœ…      | Works with official Willow Skill Tree and character refreshes                    |
| âœ…      | Safe component wrapping - doesn't break other mods                               |
| âœ…      | Server-side only - no client synchronization issues                              |
| âœ…      | Works in multiplayer and dedicated servers                                       |
| âš ï¸      | May have reduced effectiveness with mods that completely replace burnable/combat |

---

## ğŸ“¥ Installation

### **Steam Workshop (Recommended):**
1. Subscribe to the mod on Steam Workshop
2. Launch Don't Starve Together
3. Go to **Mods** menu and enable the mod
4. Configure options if desired
5. Restart your server/world

### **Manual Installation:**
1. Download the mod files
2. Navigate to your DST mods folder:
   - **Windows**: `C:\Users\<YourUsername>\Documents\Klei\DoNotStarveTogether\<YourKleiID>\mods\`
   - **Mac**: `~/Documents/Klei/DoNotStarveTogether/<YourKleiID>/mods/`
   - **Linux**: `~/.klei/DoNotStarveTogether/<YourKleiID>/mods/`
3. Create a folder named `no-friendly-fire-willow`
4. Copy all mod files into this folder
5. Enable in-game and restart

---

## ğŸ§ª Testing & Verification

To verify the mod is working correctly:

1. **Check Console Log:**
   - Look for: `[WillowFireSafety] Unified modmain loaded - protections active (server only).`
   - Location: `<DST_Folder>/<KleiID>/server_log.txt`

2. **Test Fire Protection:**
   - Play as Willow with another player
   - Use Combustion/Bernie near ally
   - Verify ally doesn't take damage or overheat

3. **Test Loot Protection:**
   - Kill an enemy with Willow's fire
   - Check that dropped items don't smolder
   - Items should have `"loot_fireproof"` tag

4. **Test Fire Spread:**
   - Use fire abilities near trees/grass
   - Verify fire doesn't spread to environment

5. **Test Monster Burning:**
   - Ignite hostile mobs with Willow
   - Confirm they still burn and take damage normally

---

## ğŸ› Known Issues & Limitations

- Very rapid-fire attacks may occasionally bypass protection (edge case)
- Some modded fire sources may not be detected if they don't use standard components
- Visual fire effects persist even when damage is prevented (cosmetic only)

---

## ğŸ”„ Version History

**v1.1.0** (Current)
- Unified architecture - all systems in single file
- Enhanced fire source detection
- Improved loot protection system
- Added monster/hostile bypass
- Better safety and error handling

**v1.0.0**
- Initial release
- Basic fire protection features

---

## ğŸ› Issues & Feedback

If you encounter bugs or have suggestions:
- Report on Steam Workshop discussion page
- Include your `server_log.txt` with `[WillowFireSafety]` messages
- Describe steps to reproduce the issue

---

## ğŸ‘¨â€ğŸ’» Author

**Nuntchi**

---

## ğŸ“œ License

MIT License â€“ free to modify and distribute with attribution.
